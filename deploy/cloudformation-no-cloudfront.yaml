AWSTemplateFormatVersion: "2010-09-09"
Description: "ChessMatch LLM - S3 static website + API Gateway REST + Lambdas (no CloudFront)"

Parameters:
  ProjectName:
    Type: String
    Default: chessmatch
    Description: Project name used for resource naming.
  EnvironmentName:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
    Description: Environment (dev, staging, prod).

Conditions:
  IsProd: !Equals [ !Ref EnvironmentName, prod ]

Resources:
  # --- S3 Bucket (frontend + game state); static website hosting, no CloudFront ---
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${ProjectName}-${EnvironmentName}-nocf-frontend-${AWS::AccountId}"
      # Allow bucket policy to grant public read for website hosting
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: false
        IgnorePublicAcls: true
        RestrictPublicBuckets: false
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ["*"]
            AllowedMethods: [GET, HEAD]
            AllowedOrigins: ["*"]
            MaxAge: 3600
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html
    DeletionPolicy: Retain

  # Public read for static website (no CloudFront in front)
  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: "*"
            Action: s3:GetObject
            Resource: !Sub "${FrontendBucket.Arn}/*"

  # --- IAM role for Lambdas ---
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectName}-${EnvironmentName}-nocf-lambda-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole

  LambdaExecutionPolicy:
    Type: AWS::IAM::Policy
    DependsOn: LambdaExecutionRole
    Properties:
      PolicyName: !Sub "${ProjectName}-${EnvironmentName}-lambda-policy"
      Roles: [ !Ref LambdaExecutionRole ]
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
            Resource: !Sub "${FrontendBucket.Arn}/*"
          - Effect: Allow
            Action: lambda:InvokeFunction
            Resource: !GetAtt GameRunLambda.Arn
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:llm-api-secrets*"

  # --- Lambda: GET /api/state ---
  StateLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-nocf-api-state"
      Runtime: python3.12
      Handler: handler.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 10
      MemorySize: 128
      Environment:
        Variables:
          STATE_BUCKET: !Ref FrontendBucket
          STATE_KEY: "game_state/state.json"
      Code:
        ZipFile: |
          def handler(event, context):
              return {"statusCode": 200, "body": "{}"}
    Metadata:
      BuildPath: lambda/api_state

  # --- Lambda: GET /api/tick (timer-only endpoint) ---
  TickLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-nocf-api-tick"
      Runtime: python3.12
      Handler: handler.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 5
      MemorySize: 128
      Environment:
        Variables:
          STATE_BUCKET: !Ref FrontendBucket
          STATE_KEY: "game_state/state.json"
      Code:
        ZipFile: |
          def handler(event, context):
              return {"statusCode": 200, "body": "{}"}
    Metadata:
      BuildPath: lambda/api_tick

  TickLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref TickLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayRestApi}/*"

  StateLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref StateLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayRestApi}/*"

  # --- Lambda: GET /api/events ---
  EventsLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-nocf-api-events"
      Runtime: python3.12
      Handler: handler.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 5
      MemorySize: 128
      Code:
        ZipFile: |
          def handler(event, context):
              return {"statusCode": 200, "body": "event: state_updated\\ndata: {}\\n\\n"}
    Metadata:
      BuildPath: lambda/api_events

  EventsLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref EventsLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayRestApi}/*"

  # --- Lambda: POST /api/game/reset ---
  ResetLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-nocf-api-reset"
      Runtime: python3.12
      Handler: handler.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 10
      MemorySize: 128
      Environment:
        Variables:
          STATE_BUCKET: !Ref FrontendBucket
          STATE_KEY: "game_state/state.json"
      Code:
        ZipFile: |
          def handler(event, context):
              return {"statusCode": 200, "body": "{}"}
    Metadata:
      BuildPath: lambda/api_reset

  ResetLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ResetLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayRestApi}/*"

  # --- Lambda: GET /api/adapters ---
  AdaptersLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-nocf-api-adapters"
      Runtime: python3.12
      Handler: handler.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 5
      MemorySize: 128
      Code:
        ZipFile: |
          import json
          ADAPTERS = [{"id":"chatgpt","name":"ChatGPT 5.2"},{"id":"gemini","name":"Gemini"},{"id":"claude","name":"Claude"},{"id":"mistral","name":"Mistral"},{"id":"cohere","name":"Cohere"},{"id":"llama_groq","name":"Llama (Groq)"}, {"id":"grok","name":"Grok"}]
          def handler(event, context):
              return {"statusCode":200,"headers":{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Cache-Control":"no-cache"},"body":json.dumps(ADAPTERS)}
    Metadata:
      BuildPath: lambda/api_adapters

  AdaptersLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AdaptersLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayRestApi}/*"

  # --- Lambda: runs the full game loop (invoked async by GameStartLambda); code deployed by script ---
  GameRunLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-nocf-game-run"
      Runtime: python3.12
      Handler: handler.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 900
      MemorySize: 512
      Environment:
        Variables:
          STATE_BUCKET: !Ref FrontendBucket
          STATE_KEY: "game_state/state.json"
      Code:
        ZipFile: |
          def handler(event, context):
              return {"statusCode": 200, "body": "{}"}
    Metadata:
      BuildPath: lambda/game_run

  # --- Lambda: POST /api/game/start (writes initial state to S3, invokes GameRunLambda) ---
  GameStartLambda:
    Type: AWS::Lambda::Function
    DependsOn: GameRunLambda
    Properties:
      FunctionName: !Sub "${ProjectName}-${EnvironmentName}-nocf-api-game-start"
      Runtime: python3.12
      Handler: handler.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 15
      MemorySize: 256
      Environment:
        Variables:
          STATE_BUCKET: !Ref FrontendBucket
          STATE_KEY: "game_state/state.json"
          GAME_RUN_LAMBDA_NAME: !Ref GameRunLambda
      Code:
        ZipFile: |
          import json
          def handler(event, context):
              return {"statusCode":202,"headers":{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"},"body":json.dumps({"message":"Game started"})}
    Metadata:
      BuildPath: lambda/api_game_start

  GameStartLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GameStartLambda
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayRestApi}/*"

  # --- API Gateway REST API ---
  ApiGatewayRestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub "${ProjectName}-${EnvironmentName}-nocf-api"
      Description: ChessMatch LLM REST API
      EndpointConfiguration:
        Types:
          - REGIONAL

  ApiGatewayRestApiRoot:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !GetAtt ApiGatewayRestApi.RootResourceId
      PathPart: api
      RestApiId: !Ref ApiGatewayRestApi

  ApiAdaptersResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref ApiGatewayRestApiRoot
      PathPart: adapters
      RestApiId: !Ref ApiGatewayRestApi

  ApiStateResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref ApiGatewayRestApiRoot
      PathPart: state
      RestApiId: !Ref ApiGatewayRestApi

  ApiTickResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref ApiGatewayRestApiRoot
      PathPart: tick
      RestApiId: !Ref ApiGatewayRestApi

  ApiEventsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref ApiGatewayRestApiRoot
      PathPart: events
      RestApiId: !Ref ApiGatewayRestApi

  ApiGameResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref ApiGatewayRestApiRoot
      PathPart: game
      RestApiId: !Ref ApiGatewayRestApi

  ApiGameResetResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref ApiGameResource
      PathPart: reset
      RestApiId: !Ref ApiGatewayRestApi

  ApiGameStartResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      ParentId: !Ref ApiGameResource
      PathPart: start
      RestApiId: !Ref ApiGatewayRestApi

  # GET /api/state
  ApiStateMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiStateResource
      HttpMethod: GET
      AuthorizationType: NONE
      RequestParameters:
        method.request.header.Accept: false
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
          ResponseModels:
            application/json: Empty
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${StateLambda.Arn}/invocations"
        IntegrationResponses: []
    DependsOn: StateLambdaPermission

  # GET /api/tick
  ApiTickMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiTickResource
      HttpMethod: GET
      AuthorizationType: NONE
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
          ResponseModels:
            application/json: Empty
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${TickLambda.Arn}/invocations"
        IntegrationResponses: []
    DependsOn: TickLambdaPermission

  # GET /api/adapters
  ApiAdaptersMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiAdaptersResource
      HttpMethod: GET
      AuthorizationType: NONE
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
          ResponseModels:
            application/json: Empty
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdaptersLambda.Arn}/invocations"
        IntegrationResponses: []
    DependsOn:
      - AdaptersLambda
      - AdaptersLambdaPermission

  ApiAdaptersOptionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiAdaptersResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Accept'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true

  # GET /api/events
  ApiEventsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiEventsResource
      HttpMethod: GET
      AuthorizationType: NONE
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Content-Type: true
          ResponseModels: {}
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${EventsLambda.Arn}/invocations"
        IntegrationResponses: []
    DependsOn: EventsLambdaPermission

  # POST /api/game/start (writes state to S3, invokes game_run; returns 202)
  ApiGameStartMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiGameStartResource
      HttpMethod: POST
      AuthorizationType: NONE
      MethodResponses:
        - StatusCode: 202
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
          ResponseModels:
            application/json: Empty
        - StatusCode: 400
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
        - StatusCode: 503
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GameStartLambda.Arn}/invocations"
        IntegrationResponses: []
    DependsOn:
      - GameStartLambda
      - GameStartLambdaPermission

  ApiGameStartOptionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiGameStartResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Accept'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true

  # POST /api/game/reset
  ApiGameResetMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiGameResetResource
      HttpMethod: POST
      AuthorizationType: NONE
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
        - StatusCode: 500
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ResetLambda.Arn}/invocations"
        IntegrationResponses: []
    DependsOn: ResetLambdaPermission

  ApiGameResetOptionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiGameResetResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Accept'"
              method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true

  # OPTIONS for CORS on /api/state
  ApiStateOptionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiStateResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Accept'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true

  # OPTIONS for CORS on /api/tick
  ApiTickOptionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiTickResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Accept'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true

  # OPTIONS for CORS on /api/events
  ApiEventsOptionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiEventsResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,Accept'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Origin: true
            method.response.header.Access-Control-Allow-Headers: true
            method.response.header.Access-Control-Allow-Methods: true

  ApiGatewayDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - ApiAdaptersMethod
      - ApiAdaptersOptionsMethod
      - ApiGameStartMethod
      - ApiGameStartOptionsMethod
      - ApiStateMethod
      - ApiTickMethod
      - ApiEventsMethod
      - ApiGameResetMethod
      - ApiGameResetOptionsMethod
      - ApiStateOptionsMethod
      - ApiTickOptionsMethod
      - ApiEventsOptionsMethod
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      StageName: !Ref EnvironmentName
      # Force new deployment when any method changes (avoids 403 MissingAuthenticationToken for new routes)
      Description: !Sub "Deploy ${ApiAdaptersMethod}-${ApiStateMethod}-${ApiEventsMethod}-${ApiGameResetMethod}-${ApiGameStartMethod}"

Outputs:
  FrontendBucketName:
    Description: S3 bucket for frontend assets and game_state/state.json
    Value: !Ref FrontendBucket
    Export:
      Name: !Sub "${AWS::StackName}-FrontendBucket"
  FrontendWebsiteURL:
    Description: S3 static website URL (HTTP only; use for frontend). Review page is /review.html
    Value: !GetAtt FrontendBucket.WebsiteURL
    Export:
      Name: !Sub "${AWS::StackName}-FrontendWebsiteURL"
  ApiEndpoint:
    Description: API Gateway invoke URL (set as API_BASE in frontend when frontend is on S3 website)
    Value: !Sub "https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${EnvironmentName}"
    Export:
      Name: !Sub "${AWS::StackName}-ApiEndpoint"
  ApiGatewayId:
    Description: API Gateway REST API ID
    Value: !Ref ApiGatewayRestApi
  StateLambdaArn:
    Description: State Lambda function ARN
    Value: !GetAtt StateLambda.Arn
  EventsLambdaArn:
    Description: Events Lambda function ARN
    Value: !GetAtt EventsLambda.Arn
  ResetLambdaArn:
    Description: Reset Lambda function ARN
    Value: !GetAtt ResetLambda.Arn
